<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>ğŸ˜ˆ Ultra Degen Farmer</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase COMPAT -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>

<body class="bg-slate-950 text-slate-200 p-4">

<h1 class="text-green-400 text-3xl font-bold">ğŸ˜ˆ Ultra Degen Farmer</h1>
<p id="today" class="text-slate-400 mb-4"></p>

<!-- ================= AUTH ================= -->
<div id="authBox" class="bg-slate-900 p-4 rounded-xl mb-4">
  <h3 class="font-bold mb-2">ğŸ” Login / Signup</h3>
  <input id="email" class="w-full p-2 rounded text-black mb-2" placeholder="Email">
  <input id="password" type="password" class="w-full p-2 rounded text-black mb-2" placeholder="Password">
  <button onclick="signup()" class="bg-blue-500 w-full py-2 rounded font-bold mb-2">Signup</button>
  <button onclick="signin()" class="bg-green-500 w-full py-2 rounded font-bold">Signin</button>
</div>

<!-- ================= APP ================= -->
<div id="app" class="hidden">

<button onclick="logout()" class="text-red-400 text-sm mb-3">Logout</button>

<!-- â• ADD BUTTON -->
<button onclick="openAddModal()"
  class="bg-green-500 w-full py-3 rounded-xl font-bold mb-4">
  â• Tambah Garapan
</button>

<!-- ================= TABLE ACTIVE ================= -->
<div class="bg-slate-900 p-4 rounded-xl mb-4 overflow-x-auto">
  <table class="w-full text-sm border border-slate-700">
    <thead class="bg-slate-800">
      <tr>
        <th class="p-2">No</th>
        <th class="p-2 text-left">Nama</th>
        <th class="p-2">Link</th>
        <th class="p-2">Kategori</th>
        <th class="p-2">Keterangan</th>
        <th class="p-2">Aksi</th>
      </tr>
    </thead>
    <tbody id="activeTable"></tbody>
  </table>
</div>

<!-- ================= COMPLETED ================= -->
<h3 class="font-bold mt-6 mb-2 text-green-400">âœ… Completed</h3>
<div class="overflow-x-auto mb-6">
  <table class="w-full text-sm border border-slate-700">
    <thead class="bg-slate-800">
      <tr>
        <th class="p-2">No</th>
        <th class="p-2 text-left">Nama</th>
        <th class="p-2">Kategori</th>
        <th class="p-2">Keterangan</th>
      </tr>
    </thead>
    <tbody id="completedTable"></tbody>
  </table>
</div>

<!-- ================= DASHBOARD BAWAH ================= -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-10">

  <!-- HEATMAP -->
  <div class="bg-slate-900 p-4 rounded-xl">
    <h3 id="heatmapTitle" class="font-bold mb-3"></h3>

    <!-- kunci ukuran heatmap -->
    <div class="max-w-[320px] mx-auto">
      <div
        id="monthHeatmap"
        class="grid grid-cols-7 gap-1 text-[10px] justify-items-center">
      </div>
    </div>
  </div>

  <!-- REMINDER -->
  <div class="bg-slate-900 p-4 rounded-xl">
    <h3 class="font-bold mb-3">ğŸ§  Reminder Farming</h3>
    <input
      type="time"
      id="reminderTime"
      class="w-full p-2 rounded text-black mb-3">
    <button
      onclick="setReminder()"
      class="bg-green-500 w-full py-2 rounded font-bold">
      Set Reminder
    </button>
  </div>

  <!-- IMPORT EXPORT -->
  <div class="bg-slate-900 p-4 rounded-xl">
    <h3 class="font-bold mb-3">ğŸ“¤ Import / Export</h3>
    <input type="file" id="csvFile" accept=".csv" class="mb-3">
    <button
      onclick="importCSV()"
      class="bg-blue-500 w-full py-2 rounded font-bold mb-2">
      Import CSV
    </button>
    <button
      onclick="exportCSV()"
      class="bg-green-500 w-full py-2 rounded font-bold">
      Export CSV
    </button>
  </div>

</div>

<!-- ================= MODAL ================= -->
<div id="taskModal"
  class="fixed inset-0 bg-black/70 hidden flex items-center justify-center z-50">
  <div class="bg-slate-900 p-5 rounded-xl w-full max-w-md mx-4">
    <h3 id="modalTitle" class="font-bold mb-3 text-lg"></h3>

    <input id="taskName" class="w-full p-2 rounded text-black mb-2" placeholder="Nama Garapan">
    <input id="taskWallet" class="w-full p-2 rounded text-black mb-2" placeholder="Wallet / Label">
    <input id="taskLink" class="w-full p-2 rounded text-black mb-2" placeholder="Link (opsional)">

    <select id="taskType" class="w-full p-2 rounded text-black mb-2">
      <option value="testnet">Testnet</option>
      <option value="point">Point</option>
      <option value="social">Social</option>
      <option value="retro">Retro</option>
      <option value="other">Other</option>
    </select>

    <textarea id="taskNote" class="w-full p-2 rounded text-black mb-3"
      placeholder="Keterangan"></textarea>

    <div class="flex gap-2">
      <button onclick="submitTask()" class="bg-green-500 flex-1 py-2 rounded font-bold">Simpan</button>
      <button onclick="closeModal()" class="bg-slate-700 flex-1 py-2 rounded">Batal</button>
    </div>
  </div>
</div>

<script>
/* ================= DATE ================= */
const todayObj = new Date();
const today = todayObj.toISOString().split("T")[0];
const year = todayObj.getFullYear();
const todayEl = document.getElementById("today");
todayEl.innerText = "ğŸ“… " + today;
const monthNames = [
  "Januari","Februari","Maret","April","Mei","Juni",
  "Juli","Agustus","September","Oktober","November","Desember"
];

/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyAMMZ5nXovO8_KnWf3qTHTRsJXoeLsJHHI",
  authDomain: "ultra-degen-farmer.firebaseapp.com",
  databaseURL: "https://ultra-degen-farmer-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "ultra-degen-farmer"
});
const auth = firebase.auth();
const dbRoot = firebase.database();

/* ================= STATE ================= */
let userRef = null;
let editTaskId = null;
let db = { year, tasks: [], history: {}, reminder: null };

/* ================= AUTH ================= */
auth.onAuthStateChanged(user=>{
  if(!user){ authBox.classList.remove("hidden"); app.classList.add("hidden"); return; }
  authBox.classList.add("hidden"); app.classList.remove("hidden");
  userRef = dbRoot.ref("ultra_degen/"+user.uid);
  userRef.on("value", snap=>{
    const d = snap.val() || {};
    db = {
      year: d.year || year,
      tasks: Array.isArray(d.tasks) ? d.tasks : [],
      history: d.history || {},
      reminder: d.reminder || null
    };
    render();
  });
});
function signup(){ auth.createUserWithEmailAndPassword(email.value,password.value).catch(e=>alert(e.message)); }
function signin(){ auth.signInWithEmailAndPassword(email.value,password.value).catch(e=>alert(e.message)); }
function logout(){ auth.signOut(); }

/* ================= MODAL ================= */
function openAddModal(){
  editTaskId = null;
  modalTitle.innerText = "â• Tambah Garapan";
  taskName.value = taskWallet.value = taskLink.value = taskNote.value = "";
  taskType.value = "testnet";
  taskModal.classList.remove("hidden");
}
function editTask(id){
  const t = db.tasks.find(x=>x.id===id); if(!t) return;
  editTaskId = id;
  modalTitle.innerText = "âœï¸ Edit Garapan";
  taskName.value=t.name; taskWallet.value=t.wallet;
  taskLink.value=t.link||""; taskType.value=t.type; taskNote.value=t.note||"";
  taskModal.classList.remove("hidden");
}
function closeModal(){ editTaskId=null; taskModal.classList.add("hidden"); }
taskModal.onclick=e=>{ if(e.target===taskModal) closeModal(); };

/* ================= CRUD ================= */
function submitTask(){
  const name=taskName.value.trim(), wallet=taskWallet.value.trim();
  if(!name||!wallet) return alert("Nama & wallet wajib");
  if(editTaskId){
    const t=db.tasks.find(x=>x.id===editTaskId);
    Object.assign(t,{name,wallet,link:taskLink.value,type:taskType.value,note:taskNote.value});
  }else{
    db.tasks.push({id:crypto.randomUUID(),name,wallet,link:taskLink.value,type:taskType.value,note:taskNote.value});
  }
  save(); closeModal(); render();
}
function toggleTask(id){
  if(!db.history[today]) db.history[today]={};
  db.history[today][id]=!db.history[today][id];
  save(); render();
}
function removeTask(id){
  if(confirm("Hapus garapan?")){
    db.tasks=db.tasks.filter(t=>t.id!==id);
    save(); render();
  }
}
function save(){ if(userRef) userRef.set(db); }

/* ================= RENDER ================= */
function render(){
  activeTable.innerHTML=""; completedTable.innerHTML="";
  let a=1,c=1;
  db.tasks.forEach(t=>{
    const done=db.history[today]?.[t.id];
    if(done){
      completedTable.innerHTML+=`<tr class="border-t text-green-400">
        <td class="p-2">${c++}</td><td class="p-2">${t.name}</td>
        <td class="p-2">${t.type}</td><td class="p-2">${t.note||"-"}</td></tr>`;
    }else{
      activeTable.innerHTML+=`<tr class="border-t">
        <td class="p-2">${a++}</td>
        <td class="p-2">${t.name}</td>
        <td class="p-2 text-center">${t.link?`<a href="${t.link}" target="_blank" class="text-sky-400">Buka</a>`:"-"}</td>
        <td class="p-2">${t.type}</td>
        <td class="p-2">${t.note||"-"}</td>
        <td class="p-2 flex gap-2 justify-center">
          <input type="checkbox" onchange="toggleTask('${t.id}')">
          <button onclick="editTask('${t.id}')" class="text-yellow-400">âœï¸</button>
          <button onclick="removeTask('${t.id}')" class="text-red-400">ğŸ—‘ï¸</button>
        </td></tr>`;
    }
  });
  drawHeatmap();
}

/* ================= HEATMAP ================= */
function drawHeatmap(){
  monthHeatmap.innerHTML = "";

  const now = new Date();
  const y = now.getFullYear();
  const m = now.getMonth(); // bulan aktif (0-11)

  // Judul otomatis
  heatmapTitle.innerText = `ğŸ“… Bulan ${monthNames[m]}`;

  const daysInMonth = new Date(y, m + 1, 0).getDate();

  for(let day = 1; day <= daysInMonth; day++){
    const dateStr =
      `${y}-${String(m+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;

    const doneCount =
      Object.values(db.history[dateStr] || {}).filter(Boolean).length;

    const isToday = dateStr === today;

    let color = "bg-slate-800";
    if(doneCount > 0) color = "bg-green-900";
    if(doneCount > 2) color = "bg-green-600";
    if(doneCount > 5) color = "bg-green-400";

    monthHeatmap.innerHTML += `
  <div
    class="
      w-7 h-7
      flex items-center justify-center
      rounded-md
      ${color}
      ${isToday ? 'ring-2 ring-green-400' : ''}
    "
    title="${doneCount} task selesai">
    ${day}
  </div>
`;
  }
}

/* ================= REMINDER ================= */
function setReminder(){
  if(!reminderTime.value) return;
  db.reminder=reminderTime.value; save();
  Notification.requestPermission();
}
setInterval(()=>{
  if(db.reminder && new Date().toTimeString().slice(0,5)===db.reminder)
    new Notification("â° Waktunya Farming!");
},60000);

/* ================= CSV ================= */
function exportCSV(){
  let csv="name,wallet,link,type,note\n";
  db.tasks.forEach(t=>csv+=`"${t.name}","${t.wallet}","${t.link||""}","${t.type}","${t.note||""}"\n`);
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="ultra_degen_tasks.csv"; a.click();
}
function importCSV(){
  const f=csvFile.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=e=>{
    e.target.result.split("\n").slice(1).forEach(l=>{
      const [n,w,lx,t,no]=l.replace(/"/g,"").split(",");
      if(n&&w) db.tasks.push({id:crypto.randomUUID(),name:n,wallet:w,link:lx,type:t||"other",note:no||""});
    });
    save(); render();
  };
  r.readAsText(f);
}
</script>

</body>
</html>
